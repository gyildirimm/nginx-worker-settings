user nginx;

pid /var/run/nginx.pid;

# Worker process başına açık dosya limiti
# Bu değer ulimit -n değerinden küçük veya eşit olmalı
# Linux içerisinde olan limiti ezer yani aslında bu limit verilirse nginx bu limiti kullanır
# Eğer limit verilmezse container içerisindeki limit kullanılır(ulimit -n)
#worker_rlimit_nofile 65535;

# Worker process önceliği (-20 en yüksek, 20 en düşük)
# nginx worker process'lerinin işletim sistemi seviyesindeki önceliğini belirler. (Default: 0)
worker_priority 0;

# Ana worker process sayısını belirler
# auto: CPU çekirdek sayısına göre otomatik ayarlar
# Sayı: Manuel olarak worker process sayısını belirler
# worker_processes 4;
worker_processes auto;

events {
    # Her worker process'in aynı anda işleyebileceği maksimum EŞZAMANLI bağlantı sayısı
    # bu değer worker_rlimit_nofile'dan küçük olmalı (eğer tanımlıysa)
    # Hesaplama: worker_connections < (worker_rlimit_nofile - 500)
    # hesaplamada 500, nginx'in kendi dosya açma işlemleri için ayrılan sayıdır
    # NOT: Bu değer toplam istek sayısını değil, aynı anda açık olan bağlantı sayısını belirler
    worker_connections 1024;
    
    # Linux için en verimli I/O event model (epoll)
    use epoll;
    
    # bir worker'ın aynı anda birden fazla yeni bağlantıyı kabul edip edemeyeceği
    # on: Performans artışı sağlar, off: Daha dengeli dağılım
    multi_accept on;
    
    # worker process'lerin yük dengeleme stratejisi
    # off: Tüm worker'lar eşit şekilde bağlantı kabul eder (önerilen)
    # on: Sıralı olarak bağlantı kabul eder (eski davranış)
    accept_mutex off;
}

http {
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;
    
    server {
        listen 80;
        server_name localhost;
        
        root /usr/share/nginx/html;
        index index.html index.htm;
        
        location / {
            try_files $uri $uri/ =404;
        }
        
        # Worker process bilgilerini gösteren endpoint
        location /nginx-status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow ::1;
            deny all;
        }

        location /test {
            return 200 "Worker Process Test - PID: $pid \n Time: $time_local\n";
            add_header Content-Type text/plain;
        }
    }
}
